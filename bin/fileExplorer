#!/usr/bin/fish
while true
    set selection (ls -ahv --color=auto --group-directories-first | fzf \
        --bind="left:pos(2)+accept" \
        --bind="right:accept" \
        --bind="shift-up:preview-up" \
        --bind="shift-down:preview-down" \
        --bind="space:toggle" \
        --height=100% \
        --reverse \
        --multi \
        --info=default\
        --prompt="❱ " \
        --pointer=󰄾 \
        --marker=● \
        --border=bold \
        --border-label=$(pwd) \
        --preview-window=right:60% \
        --preview='
        set name (echo {})
        set sel (echo (pwd)/(echo {}))
        if test (file $sel | grep [Dd]irectory | wc -l) -ge 1
        echo -e "\e[0;34m  $name\e[0m"
        ls -alhv --color=always --group-directories-first $sel
        else if test (file $sel | grep [Ii]mage | wc -l) -ge 1
        echo -e "\e[0;32m  $name\e[0m"
        #chafa --symbols=block --size=40x50 $sel
        else
        echo -e "\e[0;36m $name\e[0m"
        bat --style=numbers --theme=Dracula --color=always $sel 2>/dev/null
        end')
    if test -d "$selection"
        cd "$selection"
    else if test -f "$selection"
        set file_type (if string match -qr '\.lua|\.json' "$selection"; echo "text"; else; file -b --mime-type "$selection" | cut -d'/' -f1; end)
        switch $file_type
            case text
                nvim "$selection"
            case inode
                nvim "$selection"
            case '*'
                xdg-open "$selection" >/dev/null 2>&1
        end
    else
        break
    end
end
